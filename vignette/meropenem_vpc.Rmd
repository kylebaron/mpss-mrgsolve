---
title: "VPC - meropenem PK model"
author: "Metrum Research Group"
---


```{r, message = FALSE}
source("../src/global.R")
source("../src/functions.R")
library(tidyverse)
library(mrgsolve)
library(data.table)
library(furrr)
library(vpc)

Sys.setenv(R_FUTURE_FORK_ENABLE=TRUE)
future::plan(future::multiprocess)


.colSet1 <- function(x,...) scale_color_brewer(palette = "Set1", ...)
.fillSet1 <- function(x,...) scale_fill_brewer(palette = "Set1", ...)

```


# Introduction

- "Population Pharmacokinetic Analysis and Dosing Regimen Optimization of 
  Meropenem in Adult Patients"
    - Li et al. J Clin Pharmacol 2006
- Meropenem is broad-spectrum carbapenem antibiotic
    - Efficacy related to time above MIC
- IV dosing every 8 hours by infusion or bolus
    - bolus over 3 to 5 minutes
    - infusion over 15 to 30 minutes
- Authors are interested in seeing if a longer infusion duration 
  can increase time above MIC

# Helper functions
```{r}
qt <- function(x,y) unname(quantile(x,prob=y/100))
lo <- function(x) qt(x,5)
hi <- function(x) qt(x,95)
med <- function(x) qt(x,50)
loci <- function(x) qt(x,2.5)
hici <- function(x) qt(x,97.5)
col1 <- "steelblue"
col2 <- "firebrick"
```

# Read and fix up the data set
```{r}
data <- 
  read_csv("../data/Simulated_DatasetMeropenem.csv", na = '.')  %>% 
  mutate(CMT=1, DUR = AMT/RATE)
```



Derive a column that describes the infusion duration for each subject
```{r}
data %<>% 
  group_by(ID) %>% 
  mutate(DUR = first(DUR[!is.na(AMT)])) %>% 
  ungroup

data <- data %>% mutate(DUR = round(DUR,1))
```

Look at distinct values of `CMT`, `EVID`, `DUR` in `data`

```{r}
count(data,CMT,EVID,DUR)
```

Derive two data frames

- One with observations only
- One with doses only

```{r}
obs <- filter(data, EVID==0)

head(obs)

dose <- filter(data, EVID==1)
```


Plot observed data
```{r}
ggplot(data=obs, aes(TIME,DV)) + 
  geom_point() +
  scale_y_log10()
```

Plot observed data by `DUR`
```{r}
ggplot(data=obs, aes(TIME,DV)) + 
  geom_point() +
  scale_y_log10() +
  facet_wrap(~DUR) + xlim(0,8)
```

# Load the meropenem model

```{r}
mod <- mread("meropenem", "../model")
see(mod)
```

This model looks a little different because we got it 
off of DDMoRe model repository.


# Set up a simulation time grid for the VPC

We want 
- Hourly observations from time of first dose to 8 hours
- Observations every 0.1 hours between 0 and 3 hours 

```{r}
des1 <- tgrid(end = 3.2, delta = 0.2, add=0.05)
des2 <- tgrid(0,8,2)
des <- c(des1,des2)
des
```


A function to do the (replicate) simulation

Arguments

- `i` the replicate number

Returns simulated data set 

- time as in `des`
- `DUR` the infusion duration 
- `TIME > 0` and `Y > 0`
- Labeled with replicate number

```{r}
simvpc <- function(i) {
  mod %>% 
    carry_out(DUR) %>%
    obsonly %>%
    mrgsim_d(dose,tgrid=des) %>% 
    filter(TIME > 0 & Y > 0) %>%
    mutate(irep = i)
}
```

Simulate

- 100 iterations
- Use mclapply
- Bind into a single data frame

```{r}
niter <- 300
out <- future_map_dfr(seq(niter), simvpc) 
```


```{r}
vpc(out)
```


# Summarize simulated data
```{r, eval=FALSE}
sum1 <- 
  out %>% 
  group_by(DUR,irep,TIME) %>%
  summarise(med=med(Y), lo=lo(Y), hi=hi(Y), N=n()) %>%
  ungroup
```


```{r}
sumdt <- as.data.table(out)

sumry <- function(x) {
  setNames(quantile(x, probs=c(0.5, 0.05, 0.95)),c("med", "lo", "hi"))
}

sum1 <- sumdt[, as.list(sumry(Y)), by = "irep,DUR,TIME"]

head(sum1)
```

gather

```{r}
sum1g <- gather(sum1, metric, value, med:hi, factor_key=TRUE)

head(sum1g)
```


```{r}
sum2 <- 
  sum1g %>% 
  group_by(DUR,TIME,metric) %>% 
  summarise(
    med = median(value), lo = loci(value), hi = hici(value)
) %>% ungroup

head(sum2)
```


```{r}
sum2l <- gather(sum2, stat, value, med:hi) %>% mutate(tail = metric != "med")

head(sum2l)
```

```{r}

rib <- filter(sum2l, stat %in% c("lo", "hi")) %>% spread(stat,value)
lin <- filter(sum2l, stat =="med") 

p1 <- 
  ggplot(rib, aes(x = TIME, group=metric))  + 
  geom_ribbon(aes(ymin = lo, ymax = hi, fill=tail),alpha=0.4) +
  geom_line(data = lin, aes(y = value, col=tail), lwd=1) + 
  facet_grid(~DUR) + scale_y_log10() + .fillSet1() + .colSet1(); p1

```

  
# Summarize observed data and add to plot
```{r}
obs1 <- 
  obs %>% 
  filter(DV > 0) %>%
  group_by(DUR,TIME) %>%
  summarise(med=med(DV), lo=lo(DV), hi=hi(DV), N=n()) %>% 
  gather(metric,value,med:hi)
```

```{r, fig.width=8}
p1 + geom_line(data=obs1, aes(TIME,value), lty=2, lwd=1)
```



